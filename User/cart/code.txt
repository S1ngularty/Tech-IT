<?php 
include '../../Administrator/includes/config.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Rest of your checkout code...
}
if (!isset($_SESSION['user_id'])) {
    echo "Please log in to checkout products.";
    exit;
}

$account_id = $_SESSION['user_id'];
$order_total = 0;

// Step 1: Retrieve items from the cart
$cart_query = "SELECT cart.cart_id, cart.product_id, cart.quantity, product.price
               FROM cart
               JOIN product ON cart.product_id = product.product_id
               WHERE cart.account_id = $account_id";
$cart_result = mysqli_query($conn, $cart_query);

$orderline_data = [];
while ($row = mysqli_fetch_assoc($cart_result)) {
    $product_id = $row['product_id'];
    $quantity = $row['quantity'];
    $price = $row['price'];
    $line_total = $price * $quantity;
    
    $order_total += $line_total;

    // Store each cart item data for later insertion into orderline
    $orderline_data[] = [
        'product_id' => $product_id,
        'quantity' => $quantity,
        'price' => $price,
        'line_total' => $line_total
    ];
}
$order_query = "INSERT INTO orders (account_id, order_date, total_amount) 
                VALUES ($account_id, NOW(), $order_total)";
if (mysqli_query($conn, $order_query)) {
    // Retrieve the newly created order_id
    $order_id = mysqli_insert_id($conn);

    // Step 4: Insert each item from the cart into the orderline table
    foreach ($orderline_data as $item) {
        $product_id = $item['product_id'];
        $quantity = $item['quantity'];
        $price = $item['price'];
        $line_total = $item['line_total'];
        
        $orderline_query = "INSERT INTO orderline (order_id, product_id, quantity, unit_price, total_price, created) 
                            VALUES ($order_id, $product_id, $quantity, $price, $line_total, NOW())";
        mysqli_query($conn, $orderline_query);
    }

    // Step 5: Clear the cart after the order is placed
    $clear_cart_query = "DELETE FROM cart WHERE account_id = $account_id";
    mysqli_query($conn, $clear_cart_query);

    echo "<h3>Order successfully placed!</h3>";
    echo "<p>Total Order Amount: $$order_total</p>";
    echo "<a href='orders.php'>View Orders</a>";
} else {
    echo "<h3>Order failed. Please try again later.</h3>";
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Tech-IT</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="checkout-confirmation">
        <?php if (isset($order_total)) : ?>
            <h2>Checkout Completed</h2>
            <p>Total Amount: $<?php echo number_format($order_total, 2); ?></p>
            <a href="orders.php" class="view-orders-btn">View Orders</a>
        <?php endif; ?>
    </div>
</body>
</html>